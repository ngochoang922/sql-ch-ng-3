use master

create database QLGH
use qlgh
CREATE TABLE KHACHHANG(
	MAKHACHHANG INT PRIMARY KEY NOT NULL,
	TENCONGTY NVARCHAR(100),
	TENGIAODICH	NVARCHAR(100),
	DIACHI NVARCHAR(100),
	EMAIL VARCHAR(100),
	DIENTHOAI INT,
	FAX	VARCHAR(100),
)

CREATE TABLE DONDATHANG(
	SOHOADON INT PRIMARY KEY NOT NULL,
	MAKHACHHANG INT NOT NULL,
	MANHANVIEN INT NOT NULL,
	NGAYDATHANG DATE NOT NULL,
	NGAYGIAOHANG DATE NOT NULL,
	NGAYCHUYENHANG DATE NOT NULL,
	NOIGIAOHANG VARCHAR(100) NOT NULL,
)

CREATE TABLE NHANVIEN(
	MANHANVIEN INT PRIMARY KEY NOT NULL,
	HO VARCHAR(100) NOT NULL,
	TEN VARCHAR(100) NOT NULL,
	NGAYSINH DATE NOT NULL,
	NGAYLAMVIEC DATE NOT NULL,
	DIACHI VARCHAR(100) NOT NULL,
	DIENTHOAI VARCHAR(11) NOT NULL,
	LUONGCOBAN INT NOT NULL,
	PHUCAP INT,
)

CREATE TABLE LOAIHANG(
	MALOAIHANG INT PRIMARY KEY NOT NULL,
	TENLOAIHANG VARCHAR(100) NOT NULL,
)

CREATE TABLE MATHANG(
	MAHANG INT PRIMARY KEY NOT NULL,
	TENHANG VARCHAR(100) NOT NULL,
	MACONGTY INT NOT NULL,
	MALOAIHANG INT NOT NULL,
	SOLUONG INT NOT NULL,
	DONVITINH NVARCHAR(100),
	GIAHANG INT,
)

CREATE TABLE NHACUNGCAP(
	MACONGTY INT PRIMARY KEY NOT NULL,
	TENCONGTY VARCHAR(100) NOT NULL,
	TENGIAODICH VARCHAR(100),
	DIACHI VARCHAR(100) NOT NULL,
	DIENTHOAI VARCHAR(11) NOT NULL,
	FAX VARCHAR(100),
	EMAIL VARCHAR(100),
)

CREATE TABLE CHITIETDATHANG(
	SOHOADON INT NOT NULL,
	MAHANG INT NOT NULL,
	GIABAN INT NOT NULL,
	SOLUONG INT NOT NULL,
	MUCGIAMGIA INT,

	PRIMARY KEY(SOHOADON, MAHANG)
) 

ALTER TABLE DONDATHANG
ADD CONSTRAINT FK_MAKHACHHANG
FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG);

ALTER TABLE DONDATHANG
ADD CONSTRAINT FK_DONDATHANG_NHANVIEN
FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN);

ALTER TABLE CHITIETDATHANG
ADD CONSTRAINT FK_CHITIETDATHANG_DONDATHANG
FOREIGN KEY (SOHOADON) REFERENCES DONDATHANG(SOHOADON);

ALTER TABLE CHITIETDATHANG
ADD CONSTRAINT FK_CHITIETDATHANG_MATHANG
FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG);

ALTER TABLE MATHANG
ADD CONSTRAINT FK_MAHANG_NHACUNGCAP
FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP(MACONGTY);

ALTER TABLE MATHANG
ADD CONSTRAINT FK_MAHANG_LOAIHANG
FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG(MALOAIHANG);

INSERT INTO KHACHHANG (MAKHACHHANG, TENCONGTY, TENGIAODICH, DIACHI, EMAIL, DIENTHOAI, FAX)
VALUES
(1, 'Công ty A', 'Khách hàng A', 'Địa chỉ A', 'khachhangA@email.com', 123456789, 'FAXA'),
(2, 'Công ty B', 'Khách hàng B', 'Địa chỉ B', 'khachhangB@email.com', 987654321, 'FAXB'),
(3, 'Công ty C', 'Khách hàng C', 'Địa chỉ C', 'khachhangC@email.com', 456789123, 'FAXC');

INSERT INTO NHANVIEN (MANHANVIEN, HO, TEN, NGAYSINH, NGAYLAMVIEC, DIACHI, DIENTHOAI, LUONGCOBAN, PHUCAP)
VALUES
(1, 'Nguyen', 'Van A', '1990-01-01', '2020-01-01', 'Dia chi A', '0123456789', 5000000, NULL),
(2, 'Tran', 'Thi B', '1995-02-02', '2021-02-01', 'Dia chi B', '0987654321', 6000000, NULL),
(3, 'Le', 'Van C', '2000-03-03', '2022-03-01', 'Dia chi C', '0369852147', 7000000, NULL);

INSERT INTO LOAIHANG (MALOAIHANG, TENLOAIHANG)
VALUES
(1, 'Thực phẩm'),
(2, 'Đồ dùng gia đình'),
(3, 'Đồ điện tử');

INSERT INTO NHACUNGCAP (MACONGTY, TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, FAX, EMAIL)
VALUES
(11, 'Vinamilk Company', 'VINAMILK', 'Địa chỉ mới', '0987654321', NULL, NULL),
(12, 'Công ty Bánh quy', 'BANHQUY', 'Địa chỉ Bánh quy', '0123456789', NULL, NULL),
(13, 'Công ty Đèn LED', 'DENLED', 'Địa chỉ Đèn LED', '0369852147', NULL, NULL),
(14, N'Công ty Việt Tiến', N'Việt Tiến', N'Địa chỉ công ty', 'SốDDieenjTHoai', NULL ,NULL);

UPDATE NHACUNGCAP
SET dienthoai = '08472813762'
WHERE macongty = 14;

INSERT INTO MATHANG (MAHANG, TENHANG, MACONGTY, MALOAIHANG, SOLUONG, DONVITINH, GIAHANG)
VALUES
(1, 'Sữa hộp XYZ', 11, 1, 100, 'Hộp', 50000),
(2, 'Bánh quy ABC', 12, 1, 150, 'Hộp', 30000),
(3, 'Đèn LED', 13, 3, 50, 'Cây', 100000),
(4, N'Mặt hàng A', 14, 1, 100, N'Hộp', 50000),
(5, N'Mặt hàng B', 14, 2, 150, N'Cái', 75000),
(6, N'Mặt hàng C', 14, 3, 200, N'Chai', 100000);

													
INSERT INTO DONDATHANG (SOHOADON, MAKHACHHANG, MANHANVIEN, NGAYDATHANG, NGAYGIAOHANG, NGAYCHUYENHANG, NOIGIAOHANG)
VALUES
(22, 1, 1, '2024-03-10', '2024-03-15', '2024-03-13', 'Noi giao hang A'),
(5, 2, 2, '2024-03-11', '2024-03-16', '2024-03-14', 'Noi giao hang B'),
(11, 3, 3, '2024-03-12', '2024-03-17', '2024-03-15', 'Noi giao hang C');

INSERT INTO CHITIETDATHANG (SOHOADON, MAHANG, GIABAN, SOLUONG, MUCGIAMGIA)
VALUES
(1, 1, 50000, 2, 0),
(2, 2, 30000, 3, 0),
(3, 3, 100000, 1, 10);


--Sử dụng câu lệnh SELECT để viết các yêu cầu truy vấn dữ liệu sau đây:
--1. Cho biết danh sách các đối tác cung cấp hàng.
SELECT * FROM NHACUNGCAP;

--2. Mã hàng, tên hàng và số lượng của các mặt hàng hiện có trong công ty.
SELECT MAHANG, TENHANG, SOLUONG
FROM MATHANG;

--3. Họ tên và địa chỉ và năm bắt đầu làm việc của các nhân viên trong công ty.
SELECT HO + ' ' + TEN AS HoTen, DIACHI, YEAR(NGAYLAMVIEC) AS NamBatDauLamViec
FROM NHANVIEN;

--4. Địa chỉ và điện thoại của nhà cung cấp có tên giao dịch VINAMILK là gì?
SELECT DIACHI, DIENTHOAI
FROM NHACUNGCAP
WHERE TENGIAODICH = N'VINAMILK';

--5. Cho biết mã và tên của các mặt hàng có giá lớn hơn 100000 và số lượng hiện có ít hơn 50.
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE GIAHANG > 100000 AND SOLUONG < 50;

--6. Mỗi mặt hàng trong công ty do ai cung cấp.
SELECT M.MAHANG, M.TENHANG, N.TENCONGTY AS NHACUNGCAP
FROM MATHANG M
INNER JOIN NHACUNGCAP N ON M.MACONGTY = N.MACONGTY;

--7. Công ty Việt Tiến đã cung cấp mặt hàng nào?
SELECT M.MAHANG, M.TENHANG
FROM MATHANG M
INNER JOIN NHACUNGCAP N ON M.MACONGTY = N.MACONGTY
WHERE N.TENCONGTY = N'Việt Tiến';

--8. Loại hàng thực phẩm do những công ty nào cung cấp và địa chỉ của các công ty đó là gì?
SELECT NHACUNGCAP.TENCONGTY, NHACUNGCAP.DIACHI
FROM NHACUNGCAP
INNER JOIN MATHANG ON NHACUNGCAP.MACONGTY = MATHANG.MACONGTY
INNER JOIN LOAIHANG ON MATHANG.MALOAIHANG = LOAIHANG.MALOAIHANG
WHERE LOAIHANG.TENLOAIHANG = N'Thực phẩm';

--9. Những khách hàng nào (tên giao dịch) đã đặt mua mặt hàng Sữa hộp XYZ của công ty?
SELECT KHACHHANG.TENGIAODICH
FROM KHACHHANG
INNER JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE MATHANG.TENHANG = N'Sữa hộp XYZ';

--10. Đơn đặt hàng số 1 do ai đặt, do nhân viên nào lập, thời gian, địa điểm giao hàng là ở đâu?
SELECT KHACHHANG.TENGIAODICH AS NGUOIDATHANG, NHANVIEN.HO + ' ' + NHANVIEN.TEN AS NHANVIENLAPDON, 
    DONDATHANG.NGAYDATHANG, DONDATHANG.NOIGIAOHANG
FROM DONDATHANG
INNER JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
INNER JOIN NHANVIEN ON DONDATHANG.MANHANVIEN = NHANVIEN.MANHANVIEN
WHERE DONDATHANG.SOHOADON = 1;

--11. Số tiền lương phải trả cho mỗi nhân viên là bao nhiêu (lương = lương cơ bản + phụ cấp).
SELECT MANHANVIEN, HO + ' ' + TEN AS HOTEN, (LUONGCOBAN + ISNULL(PHUCAP, 0)) AS LUONG
FROM NHANVIEN;

--12. Trong đơn đặt hàng số 3 đặt mua những mặt hàng nào và số tiền 
--mà khách hàng phải trả cho mỗi mặt hàng là bao nhiêu 
--(số tiền phải trả được tính theo công thức: soluong*giaban*(1 - mucgiamgia/100).
SELECT M.MAHANG, M.TENHANG, 
       (CTDH.SOLUONG * M.GIAHANG * (1 - CTDH.MUCGIAMGIA / 100)) AS SOTIEN_PHAITRA
FROM CHITIETDATHANG CTDH
JOIN MATHANG M ON CTDH.MAHANG = M.MAHANG
WHERE CTDH.SOHOADON = 3;

--13. Khách hàng nào lại chính là đối tác cung cấp hàng của công ty (tức là có cùng tên giao dịch).
SELECT KH.MAKHACHHANG, KH.TENGIAODICH
FROM KHACHHANG KH
JOIN NHACUNGCAP NCC ON KH.TENGIAODICH = NCC.TENGIAODICH;

--14. Những nhân viên nào có cùng ngày sinh?
SELECT A.MANHANVIEN, A.HO, A.TEN, A.NGAYSINH, B.MANHANVIEN, B.HO, B.TEN, B.NGAYSINH
FROM NHANVIEN A, NHANVIEN B
WHERE A.MANHANVIEN <> B.MANHANVIEN AND A.NGAYSINH = B.NGAYSINH;

--15. Những đơn đặt hàng nào yêu cầu giao hàng ngay tại 
--công ty đặt hàng và những đơn đó là của công ty nào?
SELECT DONDATHANG.SOHOADON, KHACHHANG.TENCONGTY AS CONGTY_DAT_HANG
FROM DONDATHANG
INNER JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
WHERE DONDATHANG.NOIGIAOHANG = 'Công ty' AND DONDATHANG.NOIGIAOHANG = KHACHHANG.TENCONGTY;

--16. Cho biết tên công ty, tên giao dịch, địa chỉ và điện thoại 
--của các khách hàng và các nhà cung cấp hàng.
-- Thông tin của khách hàng
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI
FROM KHACHHANG
UNION
-- Thông tin của nhà cung cấp hàng
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI
FROM NHACUNGCAP;

--17. Những mặt hàng nào chưa từng được đặt mua?
SELECT M.MAHANG, M.TENHANG
FROM MATHANG M
LEFT JOIN CHITIETDATHANG C ON M.MAHANG = C.MAHANG
WHERE C.MAHANG IS NULL;

--18. Những nhân viên nào của công ty chưa từng lập bất kỳ một hóa đơn đặt hàng nào?
SELECT NV.MANHANVIEN, NV.HO, NV.TEN
FROM NHANVIEN NV
LEFT JOIN DONDATHANG DDH ON NV.MANHANVIEN = DDH.MANHANVIEN
WHERE DDH.MANHANVIEN IS NULL;

--19. Những nhân viên nào của công ty có lương cơ bản cao nhất?
SELECT TOp 1MANHANVIEN, HO, TEN, LUONGCOBAN
FROM NHANVIEN
ORDER BY LUONGCOBAN DESC

--20. Tổng số tiền mà khách hàng phải trả cho mỗi đơn đặt hàng là bao nhiêu?
SELECT DONDATHANG.SOHOADON, KHACHHANG.TENGIAODICH AS TEN_KHACHHANG, 
SUM(CHITIETDATHANG.SOLUONG * CHITIETDATHANG.GIABAN * (1 - CHITIETDATHANG.MUCGIAMGIA/100)) AS TONG_TIEN
FROM DONDATHANG
JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY DONDATHANG.SOHOADON, KHACHHANG.TENGIAODICH;

--21. Trong năm 2022, những mặt hàng nào chỉ được đặt mua đúng một lần.
SELECT M.TENHANG
FROM MATHANG M
JOIN CHITIETDATHANG C ON M.MAHANG = C.MAHANG
JOIN DONDATHANG D ON C.SOHOADON = D.SOHOADON
WHERE YEAR(D.NGAYDATHANG) = 2022
GROUP BY M.TENHANG
HAVING COUNT(D.SOHOADON) = 1;

--22. Hãy cho biết mỗi một khách hàng đã phải bỏ ra bao nhiêu tiền để đặt mua hàng của công ty?
SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENCONGTY, 
SUM(CHITIETDATHANG.GIABAN * CHITIETDATHANG.SOLUONG) AS TONGTIEN
FROM KHACHHANG
JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENCONGTY;

--23. Mỗi một nhân viên của công ty đã lập bao nhiêu đơn đặt hàng 
--(nếu nhân viên chưa hề lập một hóa đơn nào thì cho kết quả là 0).
SELECT NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN, 
       COUNT(DONDATHANG.SOHOADON) AS SoDonDatHang
FROM NHANVIEN
LEFT JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
GROUP BY NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN;

--24. Số tiền nhiều nhất mà mỗi khách hàng đã từng bỏ ra để đặt hàng trong các đơn đặt hàng là bao nhiêu?
SELECT TongTienKhachHang.MAKHACHHANG, KHACHHANG.TENCONGTY, 
MAX(TongTienKhachHang.TONGTIEN) AS SoTienMax
FROM (
    SELECT DONDATHANG.MAKHACHHANG, 
	SUM(CHITIETDATHANG.GIABAN * CHITIETDATHANG.SOLUONG) AS TONGTIEN
    FROM DONDATHANG
    JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    GROUP BY DONDATHANG.MAKHACHHANG
) AS TongTienKhachHang
JOIN KHACHHANG ON TongTienKhachHang.MAKHACHHANG = KHACHHANG.MAKHACHHANG
GROUP BY TongTienKhachHang.MAKHACHHANG, KHACHHANG.TENCONGTY;

--25. Cho biết tổng số tiền hàng mà cửa hàng thu được trong mỗi tháng của năm 2022 
--(thời được gian tính theo ngày đặt hàng).
SELECT 
    YEAR(DONDATHANG.NGAYDATHANG) AS Nam,
    MONTH(DONDATHANG.NGAYDATHANG) AS Thang,
    SUM(CHITIETDATHANG.GIABAN * CHITIETDATHANG.SOLUONG) AS TongTienHang
FROM 
    DONDATHANG
JOIN 
    CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
WHERE 
    YEAR(DONDATHANG.NGAYDATHANG) = 2022
GROUP BY 
    YEAR(DONDATHANG.NGAYDATHANG), MONTH(DONDATHANG.NGAYDATHANG);
-------sử dụng hàm YEAR và MONTH để trích xuất năm và tháng từ cột NGAYDATHANG.
-------Sử dụng SUM để tính tổng số tiền hàng cho mỗi tháng.
-------Sử dụng GROUP BY để nhóm các kết quả theo năm và tháng.

--26. Hãy cho biết dơn đặt hàng nào có số lượng hàng được đặt mua ít nhất?
SELECT TOP 1 DONDATHANG.SOHOADON, DONDATHANG.MAKHACHHANG, KHACHHANG.TENCONGTY, 
MIN(CHITIETDATHANG.SOLUONG) AS SoLuongMin
FROM DONDATHANG
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
GROUP BY DONDATHANG.SOHOADON, DONDATHANG.MAKHACHHANG, KHACHHANG.TENCONGTY
ORDER BY SoLuongMin;

--27. Hãy cho biết tổng số tiền lời mà công ty thu được từ mỗi mặt hàng trong năm 2022.
SELECT MATHANG.MAHANG, MATHANG.TENHANG, 
SUM((CHITIETDATHANG.GIABAN - MATHANG.GIAHANG) * CHITIETDATHANG.SOLUONG) AS TongLoi
FROM MATHANG
JOIN CHITIETDATHANG ON MATHANG.MAHANG = CHITIETDATHANG.MAHANG
JOIN DONDATHANG ON CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON
WHERE YEAR(DONDATHANG.NGAYDATHANG) = 2022
GROUP BY MATHANG.MAHANG, MATHANG.TENHANG;
--28. Cho biết tổng số lượng hàng của mỗi mặt hàng mà công ty đã có (tổng số lượng hàng hiện có và đã bán).
SELECT MATHANG.MAHANG, MATHANG.TENHANG,
       SUM(ISNULL(CHITIETDATHANG.SOLUONG, 0)) + MATHANG.SOLUONG AS TongSoLuong
FROM MATHANG
LEFT JOIN CHITIETDATHANG ON MATHANG.MAHANG = CHITIETDATHANG.MAHANG
GROUP BY MATHANG.MAHANG, MATHANG.TENHANG, MATHANG.SOLUONG;

--29. Nhân viên nào của công ty bán được số lượng hàng nhiều nhất và số lượng 
--hàng bán được của những nhân viên này là bao nhiêu?
SELECT NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN, 
SUM(CHITIETDATHANG.SOLUONG) AS SoLuongBanDuoc
FROM NHANVIEN
JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN
HAVING SUM(CHITIETDATHANG.SOLUONG) = (
    SELECT MAX(TongSoLuong)
    FROM (
        SELECT NHANVIEN.MANHANVIEN, 
		SUM(CHITIETDATHANG.SOLUONG) AS TongSoLuong
        FROM NHANVIEN
        JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
        JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
        GROUP BY NHANVIEN.MANHANVIEN
    ) AS TongSoLuongBanDuoc
);
--30. Mỗi một đơn đặt hàng đặt mua những mặt hàng nào và tổng số tiền mà mỗi đơn đặt hàng phải trả là bao nhiêu?
SELECT 
    DONDATHANG.SOHOADON,
    MATHANG.TENHANG,
    CHITIETDATHANG.SOLUONG,
    CHITIETDATHANG.GIABAN,
    CHITIETDATHANG.SOLUONG * CHITIETDATHANG.GIABAN AS TongTien
FROM 
    CHITIETDATHANG
JOIN 
    MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
JOIN 
    DONDATHANG ON CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON;
--31. Hãy cho biết mỗi một loại hàng bao gồm những mặt hàng nào, 
--tổng số lượng hàng của mỗi loại và tổng số lượng của tất cả các 
--mặt hàng hiện có trong công ty là bao nhiêu?
SELECT 
    LH.MALOAIHANG,
    LH.TENLOAIHANG,
    M.TENHANG,
    M.SOLUONG AS SoLuongMatHang,
    SUM(M.SOLUONG) OVER() AS TongSoLuongMatHangTrongCongTy
FROM 
    LOAIHANG LH
JOIN 
    MATHANG M ON LH.MALOAIHANG = M.MALOAIHANG;
--32. Thống kê xem trong năm 2022, mỗi một mặt hàng trong 
--mỗi tháng và trong cả năm bán được với số lượng bao nhiêu.
SELECT 
    MATHANG.MAHANG,
    MATHANG.TENHANG,
    YEAR(DONDATHANG.NGAYDATHANG) AS Nam,
    MONTH(DONDATHANG.NGAYDATHANG) AS Thang,
    SUM(CHITIETDATHANG.SOLUONG) AS SoLuongBanDuoc
FROM 
    DONDATHANG
JOIN 
    CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
JOIN 
    MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE 
    YEAR(DONDATHANG.NGAYDATHANG) = 2022
GROUP BY 
    MATHANG.MAHANG, MATHANG.TENHANG, 
	YEAR(DONDATHANG.NGAYDATHANG), 
	MONTH(DONDATHANG.NGAYDATHANG);

--Yêu cầu: Kết quả được hiển thị dưới dạng bảng, hai cột đầu là mã hàng và tên hàng, 
--các cột còn lại tương ứng với các tháng từ 1 đến 12 và cả năm. 
--Như vậy mỗi dòng trong kết quả cho biết số lượng hàng bán được mỗi tháng 
--và trong cả năm của mỗi mặt hàng. Sử dụng lệnh UPDATE thực hiện các yêu cầu sau:

--33. Cập nhật lại giá trị trường NGAYCHUYENHANG của những bản ghi có NGAYCHUYENHANG 
--chưa xác định (NULL) trong bảng DONDATHANG bằng với giá trị của trường NGAYDATHANG.
UPDATE DONDATHANG
SET NGAYCHUYENHANG = NGAYDATHANG
WHERE NGAYCHUYENHANG IS NULL;

--34. Tăng số lượng hàng của những mặt hàng do công ty VINAMILK cung cấp lên gấp đôi.
UPDATE MATHANG
SET SOLUONG = SOLUONG * 2
WHERE MACONGTY = (SELECT MACONGTY FROM NHACUNGCAP WHERE TENCONGTY = 'VINAMILK');

--35. Cập nhật giá trị của trường NOIGIAOHANG bằng địa chỉ của 
--khách hàng đối với những đơn đặt hàng chưa xác định được nơi giao hàng 
--(giá trị trường NOIGIAOHANG bằng NULL).
UPDATE DONDATHANG
SET NOIGIAOHANG = KHACHHANG.DIACHI
FROM DONDATHANG
JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
WHERE DONDATHANG.NOIGIAOHANG IS NULL;

--36. Cập nhật lại bảng KHACHHANG sao cho nếu tên công ty và tên giao dịch 
--của khách hàng trùng với tên công ty và tên giao dịch của một nhà 
--cung cấp nào đó thì địa chỉ, điện thoại, fax và e-mail phải giống nhau.
UPDATE KHACHHANG
SET
    KHACHHANG.DIACHI = NC.DIACHI,
    KHACHHANG.DIENTHOAI = NC.DIENTHOAI,
    KHACHHANG.FAX = NC.FAX,
    KHACHHANG.EMAIL = NC.EMAIL
FROM
    KHACHHANG
INNER JOIN
    NHACUNGCAP NC ON KHACHHANG.TENCONGTY = NC.TENCONGTY AND KHACHHANG.TENGIAODICH = NC.TENGIAODICH;

--37. Tăng lương lên gấp rưỡi cho nhân viên bán được số lượng hàng nhiều hơn 100 trong năm 2022.
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN * 1.5
WHERE MANHANVIEN IN (
    SELECT DISTINCT NHANVIEN.MANHANVIEN
    FROM NHANVIEN
    JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
    JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    WHERE YEAR(DONDATHANG.NGAYDATHANG) = 2022
    GROUP BY NHANVIEN.MANHANVIEN
    HAVING SUM(CHITIETDATHANG.SOLUONG) > 100
);

--38. Tăng phụ cấp lên bằng 50% lương cho những nhân viên bán được hàng nhiều nhất.
DECLARE @MaxSalesEmployeeID INT

-- Xác định nhân viên có số lượng hàng bán nhiều nhất trong năm 2022
SELECT TOP 1 WITH TIES @MaxSalesEmployeeID = NHANVIEN.MANHANVIEN
FROM NHANVIEN
JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
WHERE YEAR(DONDATHANG.NGAYDATHANG) = 2022
GROUP BY NHANVIEN.MANHANVIEN
ORDER BY SUM(CHITIETDATHANG.SOLUONG) DESC;

-- Tăng phụ cấp lên bằng 50% lương cho nhân viên có số lượng hàng bán nhiều nhất
UPDATE NHANVIEN
SET PHUCAP = LUONGCOBAN * 0.5
WHERE MANHANVIEN = @MaxSalesEmployeeID;

--39. Giảm 25% lương của nhân viên trong năm 2022 không lập được bất kỳ đơn đặt hàng nào.
-- Xác định những nhân viên không lập được bất kỳ đơn đặt hàng nào trong năm 2022
DECLARE @EmployeesWithoutOrders TABLE (MANHANVIEN INT)

INSERT INTO @EmployeesWithoutOrders (MANHANVIEN)
SELECT MANHANVIEN
FROM NHANVIEN
WHERE MANHANVIEN NOT IN (
    SELECT DISTINCT MANHANVIEN
    FROM DONDATHANG
    WHERE YEAR(NGAYDATHANG) = 2022
);

-- Giảm 25% lương của những nhân viên không lập được bất kỳ đơn đặt hàng nào trong năm 2022
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN * 0.75
WHERE MANHANVIEN IN (SELECT MANHANVIEN FROM @EmployeesWithoutOrders);

--40. Giả sử trong bảng DONDATHANG có thêm trường SOTIEN cho biết số tiền 
--mà khách hàng phải trả trong mỗi đơn đặt hàng. Hãy tính giá trị cho trường này. 
--Thực hiện các yêu cầu dưới đây bằng câu lệnh DELETE.

-- Thêm trường SOTIEN vào bảng DONDATHANG
ALTER TABLE DONDATHANG
ADD SOTIEN INT;

-- Tính toán và cập nhật giá trị cho trường SOTIEN
UPDATE DONDATHANG
SET SOTIEN = (
    SELECT SUM(CHITIETDATHANG.GIABAN * CHITIETDATHANG.SOLUONG)
    FROM CHITIETDATHANG
    WHERE CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON
    GROUP BY CHITIETDATHANG.SOHOADON
);

-- Xóa các dòng có trường SOTIEN là NULL
DELETE FROM DONDATHANG WHERE SOTIEN IS NULL;

--41. Xóa khỏi bảng NHANVIEN những nhân viên đã làm việc trong công ty quá 40 năm.
DELETE FROM NHANVIEN
WHERE DATEDIFF(YEAR, NGAYLAMVIEC, GETDATE()) >= 40;

--42. Xóa những đơn đặt hàng trước năm 2020.
DELETE FROM DONDATHANG
WHERE YEAR(NGAYDATHANG) < 2020;

--43. Xóa khỏi bảng LOAIHANG những loại hàng hiện không có mặt hàng.
DELETE FROM LOAIHANG
WHERE MALOAIHANG NOT IN (SELECT DISTINCT MALOAIHANG FROM MATHANG);

--44. Xóa khỏi bảng KHACHHANG những khách hàng hiện không có bất kỳ đơn đặt hàng nào cho công ty.
DELETE FROM KHACHHANG
WHERE MAKHACHHANG NOT IN (SELECT DISTINCT MAKHACHHANG FROM DONDATHANG);

--45. Xóa khỏi bảng MATHANG những mặt hàng có số lượng bằng 0 và 
--không được đặt mua trong bất kỳ đơn đặt hàng nào
DELETE FROM MATHANG
WHERE SOLUONG = 0
AND MAHANG NOT IN (
    SELECT DISTINCT MAHANG
    FROM CHITIETDATHANG
);

